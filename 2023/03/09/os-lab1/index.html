<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>os-lab1 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.4.2"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/categories">Categories</a>
        
          <a class="main-nav-link" href="/tags">Tags</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-os-lab1" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/03/09/os-lab1/" class="article-date">
  <time class="dt-published" datetime="2023-03-09T12:16:04.000Z" itemprop="datePublished">2023-03-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      os-lab1
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="lab1概述"><a href="#lab1概述" class="headerlink" title="lab1概述"></a>lab1概述</h2><p>在BUAA 操作系统的实验课上，主要通过GXemul来模拟裸机，从而实现编写一个mos操作系统</p>
<p>相比于前几届的实验课，就lab1而言，要简单一些，同时可以将前几届的mos操作系统作为参考，可以起到不错的提示和debug作用</p>
<p>在lab1中，从内核转移到内存开始实现，主要实现几个功能</p>
<ul>
<li>  补全readelf文件，实现readelf</li>
<li>  将内核加载到正确位置，不全kernel.lds代码</li>
<li>  完成_start函数，找到mos内核启动入口</li>
<li>  完成printk.c函数，实现输出功能</li>
</ul>
<h2 id="exercise"><a href="#exercise" class="headerlink" title="exercise"></a>exercise</h2><h3 id="exercise-1-1"><a href="#exercise-1-1" class="headerlink" title="exercise 1.1"></a>exercise 1.1</h3><p>这个练习本质上不难，只要分辨概念足可以做出题目。但是由于在操作系统课上，我们只是简单了解了elf文件的组成内容，但是并没有介绍节头表和段头表的内容，并且我认为节头表入口和段头表入口这两个概念在中文中不是经常被提及，所以容易产生问题</p>
<p>首先我们来了解节头表和段头表的概念和组成。节头表(section header table) 本质上是由若干个节头表(section header)组成，节头表不是一个结构体，相当于是节头表入口集合。节头表入口是一个结构体，在结构体中包含节头表入口的大小，和相对于elf表头的偏移量还有该节位置等信息，相当于是一个</p>
<p>指向每个节(section)的指针。并且在elf头表中，含有节头表入口的的大小，每个节头表入口大小是相同的，这是因为节头表入口时大小固定的结构体，如果想求出每个节头表入口的位置，可以通过offset(elf header) + offset-to-elfheader(section header table) + size(section header) * n来求</p>
<p>这是这道题的代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;elf.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Overview:</span></span><br><span class="line"><span class="comment"> *   Check whether specified buffer is valid ELF data.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Pre-Condition:</span></span><br><span class="line"><span class="comment"> *   The memory within [binary, binary+size) must be valid to read.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Post-Condition:</span></span><br><span class="line"><span class="comment"> *   Returns 0 if &#x27;binary&#x27; isn&#x27;t an ELF, otherwise returns 1.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">is_elf_format</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *binary, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">	Elf32_Ehdr *ehdr = (Elf32_Ehdr *)binary;</span><br><span class="line">	<span class="keyword">return</span> size &gt;= <span class="keyword">sizeof</span>(Elf32_Ehdr) &amp;&amp; ehdr-&gt;e_ident[EI_MAG0] == ELFMAG0 &amp;&amp;</span><br><span class="line">	       ehdr-&gt;e_ident[EI_MAG1] == ELFMAG1 &amp;&amp; ehdr-&gt;e_ident[EI_MAG2] == ELFMAG2 &amp;&amp;</span><br><span class="line">	       ehdr-&gt;e_ident[EI_MAG3] == ELFMAG3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Overview:</span></span><br><span class="line"><span class="comment"> *   Parse the sections from an ELF binary.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Pre-Condition:</span></span><br><span class="line"><span class="comment"> *   The memory within [binary, binary+size) must be valid to read.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Post-Condition:</span></span><br><span class="line"><span class="comment"> *   Return 0 if success. Otherwise return &lt; 0.</span></span><br><span class="line"><span class="comment"> *   If success, output the address of every section in ELF.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">readelf</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *binary, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">	Elf32_Ehdr *ehdr = (Elf32_Ehdr *)binary;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Check whether `binary` is a ELF file.</span></span><br><span class="line">	<span class="keyword">if</span> (!is_elf_format(binary, size)) &#123;</span><br><span class="line">		<span class="built_in">fputs</span>(<span class="string">&quot;not an elf file\n&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Get the address of the section table, the number of section headers and the size of a</span></span><br><span class="line">	<span class="comment">// section header.</span></span><br><span class="line">	<span class="type">const</span> <span class="type">void</span> *sh_table;</span><br><span class="line">	Elf32_Half sh_entry_count;</span><br><span class="line">	Elf32_Half sh_entry_size;</span><br><span class="line">	<span class="comment">/* Exercise 1.1: Your code here. (1/2) */</span></span><br><span class="line">	sh_table = binary + ehdr-&gt;e_shoff;</span><br><span class="line">	sh_entry_count = ehdr-&gt;e_shnum;</span><br><span class="line">	sh_entry_size = ehdr-&gt;e_shentsize;</span><br><span class="line">	<span class="comment">// For each section header, output its index and the section address.</span></span><br><span class="line">	<span class="comment">// The index should start from 0.</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; sh_entry_count; i++) &#123;</span><br><span class="line">		<span class="type">const</span> Elf32_Shdr *shdr;</span><br><span class="line">		shdr = (Elf32_Shdr *)sh_table;</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">int</span> addr;</span><br><span class="line">		<span class="comment">/* Exercise 1.1: Your code here. (2/2) */</span></span><br><span class="line">		addr = shdr-&gt;sh_addr;</span><br><span class="line">		sh_table += sh_entry_size;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%d:0x%x\n&quot;</span>, i, addr);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意：在使用结构体的指针时，要是用-&gt;而不是.</p>
<h3 id="exercise-1-2"><a href="#exercise-1-2" class="headerlink" title="exercise 1.2"></a>exercise 1.2</h3><p>这道题其实不是很难，首先要找到kernel所存的位置即可，由于在cache为启动时，是能使用kseg0作为内核代码存放位置，并且在0x80000000-0x80010000位置存放的是exception entry，就可以明白，代码段和数据段被存储在0x80010000以上就好其实要明白在linker script中，’.’是一个定位计数器，是可以改变自身位置的。</p>
<p>这道题比较容易出现问题的点就是，一定要注意linker script的格式，等号两边以及冒号两边都有空格</p>
<p>代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Set the architecture to mips.</span><br><span class="line"> */</span><br><span class="line">OUTPUT_ARCH(mips)</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * Set the ENTRY point of the program to _start.</span><br><span class="line"> */</span><br><span class="line">ENTRY(_start)</span><br><span class="line"></span><br><span class="line">SECTIONS &#123;</span><br><span class="line">	/* Exercise 3.10: Your code here. */</span><br><span class="line"></span><br><span class="line">	/* fill in the correct address of the key sections: text, data, bss. */</span><br><span class="line">	/* Exercise 1.2: Your code here. */</span><br><span class="line">	. = 0x80010000;</span><br><span class="line">	.text : &#123;</span><br><span class="line">	*(.text)</span><br><span class="line">		&#125;</span><br><span class="line">	.data : &#123;</span><br><span class="line">	*(.data)</span><br><span class="line">		&#125;</span><br><span class="line">	.bss : &#123;</span><br><span class="line">	*(.bss)</span><br><span class="line">		&#125;</span><br><span class="line">	bss_end = .;</span><br><span class="line">	. = 0x80400000;</span><br><span class="line">	end = . ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意一点就是，在上一届的操作系统实验课中，还为execption entry分配了地址空间，同时，还未.sdata段分配了空间。</p>
<h3 id="exercise1-3"><a href="#exercise1-3" class="headerlink" title="exercise1.3"></a>exercise1.3</h3><p>exercise1.3是完成mips体系结构下的start.S函数</p>
<p>在理论课上我们可以知道，在将内核放置到内存中正确的位置上以后，操作系统就要找到程序入口<em>start函数，之后进行一些初始化，包括初始化CP0寄存器，设置中断，还有设置栈指针等。本实验的</em>start函数中，只是简单的初始化了CP0寄存器，并且设置栈指针。我闷很容易有一个想法，就是我们借助上一个题目的kernel.lds中的位置关系，找到栈指针的位置。但是这样做是不现实的，同时是错误的。一方面我们可以知道不可能调用kernel.lds内容，更重要的是，栈的增长方向是向低地址增长，堆的增长方向是向高地址增长，因此这里要将栈指针放到0x84000000上</p>
<p>所以代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;asm/asm.h&gt;</span><br><span class="line">#include &lt;mmu.h&gt;</span><br><span class="line"></span><br><span class="line">.text</span><br><span class="line">EXPORT(_start)</span><br><span class="line">LEAF(_start)</span><br><span class="line">.set at</span><br><span class="line">.set reorder</span><br><span class="line">	/* disable interrupts */</span><br><span class="line">	mtc0    zero, CP0_STATUS</span><br><span class="line"></span><br><span class="line">	/* hint: you can reference the memory layout in include/mmu.h */</span><br><span class="line">	/* set up the kernel stack */</span><br><span class="line">	/* Exercise 1.3: Your code here. (1/2) */</span><br><span class="line">	li 	sp,0x80400000</span><br><span class="line">	/* jump to mips_init */</span><br><span class="line">	/* Exercise 1.3: Your code here. (2/2) */</span><br><span class="line">	jal	mips_init</span><br><span class="line">END(_start)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="exercise1-4"><a href="#exercise1-4" class="headerlink" title="exercise1.4"></a>exercise1.4</h2><p>其实这道题没什么要说的，只要顺序判断对了，其实不是很难。整个的流程图放在这里</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">flowchart LR</span><br><span class="line">A(各个变量初始化) --&gt; B(判断%或者\0的位置) --&gt; |如果是\0|C(break)</span><br><span class="line">B --&gt; |如果是%|D(fmt++) --&gt; |如果开头是-|E(表示左对齐,fmt++)</span><br><span class="line">D --&gt; |如果是0|F(则有前导零,fmt++)</span><br><span class="line">E  --&gt; G(读取width)</span><br><span class="line">F --&gt; G --&gt; |判断是否有l|H(表示是不是长整/浮点型)</span><br></pre></td></tr></table></figure>

<p>代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;print.h&gt;</span></span></span><br><span class="line"><span class="comment">/* forward declaration */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">print_char</span><span class="params">(<span class="type">fmt_callback_t</span>, <span class="type">void</span> *, <span class="type">char</span>, <span class="type">int</span>, <span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">print_str</span><span class="params">(<span class="type">fmt_callback_t</span>, <span class="type">void</span> *, <span class="type">const</span> <span class="type">char</span> *, <span class="type">int</span>, <span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">print_num</span><span class="params">(<span class="type">fmt_callback_t</span>, <span class="type">void</span> *, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">char</span>, <span class="type">int</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">vprintfmt</span><span class="params">(<span class="type">fmt_callback_t</span> out, <span class="type">void</span> *data, <span class="type">const</span> <span class="type">char</span> *fmt, va_list ap)</span> &#123;</span><br><span class="line">	<span class="type">char</span> c;</span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *s;</span><br><span class="line">	<span class="type">long</span> num;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> width;</span><br><span class="line">	<span class="type">int</span> long_flag; <span class="comment">// output is long (rather than int)</span></span><br><span class="line">	<span class="type">int</span> neg_flag;  <span class="comment">// output is negative</span></span><br><span class="line">	<span class="type">int</span> ladjust;   <span class="comment">// output is left-aligned</span></span><br><span class="line">	<span class="type">char</span> padc;     <span class="comment">// padding char</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line"></span><br><span class="line">		num = <span class="number">0</span>,width = <span class="number">0</span>,long_flag = <span class="number">0</span>,neg_flag = <span class="number">0</span>,ladjust = <span class="number">0</span>,padc = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">while</span>((*fmt) != <span class="string">&#x27;%&#x27;</span> &amp;&amp; (*fmt) != <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			print_char(out,data,*fmt,<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">			fmt++;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>((*fmt) == <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>((*fmt) == <span class="string">&#x27;%&#x27;</span>)</span><br><span class="line">			fmt++;</span><br><span class="line">		<span class="keyword">if</span>((*fmt) == <span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">			ladjust = <span class="number">1</span>,fmt++;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>((*fmt) == <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">			padc = <span class="string">&#x27;0&#x27;</span>,fmt++;</span><br><span class="line">		<span class="keyword">while</span>(((*fmt) &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; (*fmt) &lt;= <span class="string">&#x27;9&#x27;</span>))</span><br><span class="line">		&#123;	</span><br><span class="line">			width = width * <span class="number">10</span> + (*fmt) - <span class="string">&#x27;0&#x27;</span>;	</span><br><span class="line">			fmt++;</span><br><span class="line">			<span class="keyword">if</span>(padc == <span class="number">0</span>)</span><br><span class="line">			padc = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>((*fmt) == <span class="string">&#x27;l&#x27;</span>)</span><br><span class="line">			long_flag = <span class="number">1</span>,fmt++;</span><br><span class="line">		<span class="comment">/* scan for the next &#x27;%&#x27; */</span></span><br><span class="line">		<span class="comment">/* Exercise 1.4: Your code here. (1/8) */</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/* flush the string found so far */</span></span><br><span class="line">		<span class="comment">/* Exercise 1.4: Your code here. (2/8) */</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/* check &quot;are we hitting the end?&quot; */</span></span><br><span class="line">		<span class="comment">/* Exercise 1.4: Your code here. (3/8) */</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/* we found a &#x27;%&#x27; */</span></span><br><span class="line">		<span class="comment">/* Exercise 1.4: Your code here. (4/8) */</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/* check format flag */</span></span><br><span class="line">		<span class="comment">/* Exercise 1.4: Your code here. (5/8) */</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/* get width */</span></span><br><span class="line">		<span class="comment">/* Exercise 1.4: Your code here. (6/8) */</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/* check for long */</span></span><br><span class="line">		<span class="comment">/* Exercise 1.4: Your code here. (7/8) */</span></span><br><span class="line"></span><br><span class="line">		neg_flag = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">switch</span> (*fmt) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>:</span><br><span class="line">			<span class="keyword">if</span> (long_flag) &#123;</span><br><span class="line">				num = va_arg(ap, <span class="type">long</span> <span class="type">int</span>);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				num = va_arg(ap, <span class="type">int</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			print_num(out, data, num, <span class="number">2</span>, <span class="number">0</span>, width, ladjust, padc, <span class="number">0</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;D&#x27;</span>:</span><br><span class="line">			<span class="keyword">if</span> (long_flag) &#123;</span><br><span class="line">				num = va_arg(ap, <span class="type">long</span> <span class="type">int</span>);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				num = va_arg(ap, <span class="type">int</span>);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Refer to other parts (case &#x27;b&#x27;, case &#x27;o&#x27;, etc.) and func &#x27;print_num&#x27; to</span></span><br><span class="line"><span class="comment">			 * complete this part. Think the differences between case &#x27;d&#x27; and the</span></span><br><span class="line"><span class="comment">			 * others. (hint: &#x27;neg_flag&#x27;).</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="comment">/* Exercise 1.4: Your code here. (8/8) */</span></span><br><span class="line">			<span class="keyword">if</span>(num &lt; <span class="number">0</span>)</span><br><span class="line">				num = -num,neg_flag = <span class="number">1</span>;</span><br><span class="line">			print_num(out,data,num,<span class="number">10</span>,neg_flag,width,ladjust,padc,<span class="number">0</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;o&#x27;</span>:</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;O&#x27;</span>:</span><br><span class="line">			<span class="keyword">if</span> (long_flag) &#123;</span><br><span class="line">				num = va_arg(ap, <span class="type">long</span> <span class="type">int</span>);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				num = va_arg(ap, <span class="type">int</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			print_num(out, data, num, <span class="number">8</span>, <span class="number">0</span>, width, ladjust, padc, <span class="number">0</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;u&#x27;</span>:</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;U&#x27;</span>:</span><br><span class="line">			<span class="keyword">if</span> (long_flag) &#123;</span><br><span class="line">				num = va_arg(ap, <span class="type">long</span> <span class="type">int</span>);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				num = va_arg(ap, <span class="type">int</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			print_num(out, data, num, <span class="number">10</span>, <span class="number">0</span>, width, ladjust, padc, <span class="number">0</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;x&#x27;</span>:</span><br><span class="line">			<span class="keyword">if</span> (long_flag) &#123;</span><br><span class="line">				num = va_arg(ap, <span class="type">long</span> <span class="type">int</span>);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				num = va_arg(ap, <span class="type">int</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			print_num(out, data, num, <span class="number">16</span>, <span class="number">0</span>, width, ladjust, padc, <span class="number">0</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;X&#x27;</span>:</span><br><span class="line">			<span class="keyword">if</span> (long_flag) &#123;</span><br><span class="line">				num = va_arg(ap, <span class="type">long</span> <span class="type">int</span>);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				num = va_arg(ap, <span class="type">int</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			print_num(out, data, num, <span class="number">16</span>, <span class="number">0</span>, width, ladjust, padc, <span class="number">1</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;c&#x27;</span>:</span><br><span class="line">			c = (<span class="type">char</span>)va_arg(ap, <span class="type">int</span>);</span><br><span class="line">			print_char(out, data, c, width, ladjust);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">			s = (<span class="type">char</span> *)va_arg(ap, <span class="type">char</span> *);</span><br><span class="line">			print_str(out, data, s, width, ladjust);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;\0&#x27;</span>:</span><br><span class="line">			fmt--;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="comment">/* output this char as it is */</span></span><br><span class="line">			out(data, fmt, <span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		fmt++;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* --------------- local help functions --------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_char</span><span class="params">(<span class="type">fmt_callback_t</span> out, <span class="type">void</span> *data, <span class="type">char</span> c, <span class="type">int</span> length, <span class="type">int</span> ladjust)</span> &#123;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">		length = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> space = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">	<span class="keyword">if</span> (ladjust) &#123;</span><br><span class="line">		out(data, &amp;c, <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; length; i++) &#123;</span><br><span class="line">			out(data, &amp;space, <span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; length - <span class="number">1</span>; i++) &#123;</span><br><span class="line">			out(data, &amp;space, <span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		out(data, &amp;c, <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_str</span><span class="params">(<span class="type">fmt_callback_t</span> out, <span class="type">void</span> *data, <span class="type">const</span> <span class="type">char</span> *s, <span class="type">int</span> length, <span class="type">int</span> ladjust)</span> &#123;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	<span class="type">int</span> len = <span class="number">0</span>;</span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *s1 = s;</span><br><span class="line">	<span class="keyword">while</span> (*s1++) &#123;</span><br><span class="line">		len++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (length &lt; len) &#123;</span><br><span class="line">		length = len;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ladjust) &#123;</span><br><span class="line">		out(data, s, len);</span><br><span class="line">		<span class="keyword">for</span> (i = len; i &lt; length; i++) &#123;</span><br><span class="line">			out(data, <span class="string">&quot; &quot;</span>, <span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; length - len; i++) &#123;</span><br><span class="line">			out(data, <span class="string">&quot; &quot;</span>, <span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		out(data, s, len);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_num</span><span class="params">(<span class="type">fmt_callback_t</span> out, <span class="type">void</span> *data, <span class="type">unsigned</span> <span class="type">long</span> u, <span class="type">int</span> base, <span class="type">int</span> neg_flag, <span class="type">int</span> length,</span></span><br><span class="line"><span class="params">	       <span class="type">int</span> ladjust, <span class="type">char</span> padc, <span class="type">int</span> upcase)</span> &#123;</span><br><span class="line">	<span class="comment">/* algorithm :</span></span><br><span class="line"><span class="comment">	 *  1. prints the number from left to right in reverse form.</span></span><br><span class="line"><span class="comment">	 *  2. fill the remaining spaces with padc if length is longer than</span></span><br><span class="line"><span class="comment">	 *     the actual length</span></span><br><span class="line"><span class="comment">	 *     TRICKY : if left adjusted, no &quot;0&quot; padding.</span></span><br><span class="line"><span class="comment">	 *		    if negtive, insert  &quot;0&quot; padding between &quot;0&quot; and number.</span></span><br><span class="line"><span class="comment">	 *  3. if (!ladjust) we reverse the whole string including paddings</span></span><br><span class="line"><span class="comment">	 *  4. otherwise we only reverse the actual string representing the num.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> actualLength = <span class="number">0</span>;</span><br><span class="line">	<span class="type">char</span> buf[length + <span class="number">70</span>];</span><br><span class="line">	<span class="type">char</span> *p = buf;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="type">int</span> tmp = u % base;</span><br><span class="line">		<span class="keyword">if</span> (tmp &lt;= <span class="number">9</span>) &#123;</span><br><span class="line">			*p++ = <span class="string">&#x27;0&#x27;</span> + tmp;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (upcase) &#123;</span><br><span class="line">			*p++ = <span class="string">&#x27;A&#x27;</span> + tmp - <span class="number">10</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			*p++ = <span class="string">&#x27;a&#x27;</span> + tmp - <span class="number">10</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		u /= base;</span><br><span class="line">	&#125; <span class="keyword">while</span> (u != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (neg_flag) &#123;</span><br><span class="line">		*p++ = <span class="string">&#x27;-&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* figure out actual length and adjust the maximum length */</span></span><br><span class="line">	actualLength = p - buf;</span><br><span class="line">	<span class="keyword">if</span> (length &lt; actualLength) &#123;</span><br><span class="line">		length = actualLength;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* add padding */</span></span><br><span class="line">	<span class="keyword">if</span> (ladjust) &#123;</span><br><span class="line">		padc = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (neg_flag &amp;&amp; !ladjust &amp;&amp; (padc == <span class="string">&#x27;0&#x27;</span>)) &#123;</span><br><span class="line">		<span class="keyword">for</span> (i = actualLength - <span class="number">1</span>; i &lt; length - <span class="number">1</span>; i++) &#123;</span><br><span class="line">			buf[i] = padc;</span><br><span class="line">		&#125;</span><br><span class="line">		buf[length - <span class="number">1</span>] = <span class="string">&#x27;-&#x27;</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">for</span> (i = actualLength; i &lt; length; i++) &#123;</span><br><span class="line">			buf[i] = padc;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* prepare to reverse the string */</span></span><br><span class="line">	<span class="type">int</span> begin = <span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> end;</span><br><span class="line">	<span class="keyword">if</span> (ladjust) &#123;</span><br><span class="line">		end = actualLength - <span class="number">1</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		end = length - <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* adjust the string pointer */</span></span><br><span class="line">	<span class="keyword">while</span> (end &gt; begin) &#123;</span><br><span class="line">		<span class="type">char</span> tmp = buf[begin];</span><br><span class="line">		buf[begin] = buf[end];</span><br><span class="line">		buf[end] = tmp;</span><br><span class="line">		begin++;</span><br><span class="line">		end--;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	out(data, buf, length);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里需要注意一下，这个printk还不是很完善，就比如说”%.5d”这样的情况确实没有考虑到到。具体情况可以参照之前os实验，代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright (C) 2001 MontaVista Software Inc.</span></span><br><span class="line"><span class="comment"> * Author: Jun Sun, jsun@mvista.com or jsun@junsun.net</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This program is free software; you can redistribute  it and/or modify it</span></span><br><span class="line"><span class="comment"> * under  the terms of  the GNU General  Public License as published by the</span></span><br><span class="line"><span class="comment"> * Free Software Foundation;  either version 2 of the  License, or (at your</span></span><br><span class="line"><span class="comment"> * option) any later version.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span>	<span class="string">&lt;print.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* macros */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>		IsDigit(x)	( ((x) &gt;= <span class="string">&#x27;0&#x27;</span>) &amp;&amp; ((x) &lt;= <span class="string">&#x27;9&#x27;</span>) )</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>		Ctod(x)		( (x) - <span class="string">&#x27;0&#x27;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* forward declaration */</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">PrintChar</span><span class="params">(<span class="type">char</span> *, <span class="type">char</span>, <span class="type">int</span>, <span class="type">int</span>)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">PrintString</span><span class="params">(<span class="type">char</span> *, <span class="type">char</span> *, <span class="type">int</span>, <span class="type">int</span>)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">PrintNum</span><span class="params">(<span class="type">char</span> *, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">char</span>, <span class="type">int</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* private variable */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> theFatalMsg[] = <span class="string">&quot;fatal error in lp_Print!&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* -*-</span></span><br><span class="line"><span class="comment"> * A low level printf() function.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">lp_Print</span><span class="params">(<span class="type">void</span> (*output)(<span class="type">void</span> *, <span class="type">char</span> *, <span class="type">int</span>), <span class="type">void</span> * arg, <span class="type">char</span> *fmt,  va_list ap)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> 	OUTPUT(arg, s, l)  \</span></span><br><span class="line"><span class="meta">  &#123; <span class="keyword">if</span> (((l) <span class="string">&lt; 0) || ((l) &gt;</span> LP_MAX_BUF)) &#123; \</span></span><br><span class="line"><span class="meta">       (*output)(arg, (char*)theFatalMsg, sizeof(theFatalMsg)-1); for(;;); \</span></span><br><span class="line"><span class="meta">    &#125; <span class="keyword">else</span> &#123; \</span></span><br><span class="line"><span class="meta">      (*output)(arg, s, l); \</span></span><br><span class="line"><span class="meta">    &#125; \</span></span><br><span class="line"><span class="meta">  &#125;</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> buf[LP_MAX_BUF];</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> c;</span><br><span class="line">    <span class="type">char</span> *s;</span><br><span class="line">    <span class="type">long</span> <span class="type">int</span> num;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> longFlag; <span class="comment">//标记是否为long型</span></span><br><span class="line">    <span class="type">int</span> negFlag; <span class="comment">//标记是否为负数</span></span><br><span class="line">    <span class="type">int</span> width; <span class="comment">//标记输出宽度</span></span><br><span class="line">    <span class="type">int</span> prec; <span class="comment">//标记小数精度</span></span><br><span class="line">    <span class="type">int</span> ladjust; <span class="comment">// 标记是否左对齐</span></span><br><span class="line">    <span class="type">char</span> padc; <span class="comment">//填充多余位置所用的字符</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(;;) &#123;</span><br><span class="line">	</span><br><span class="line">        &#123; </span><br><span class="line">            <span class="comment">/* scan for the next &#x27;%&#x27; */</span></span><br><span class="line">            <span class="keyword">while</span>((*fmt) &amp;&amp; *fmt != <span class="string">&#x27;%&#x27;</span>) &#123;</span><br><span class="line">                OUTPUT(arg, fmt, <span class="number">1</span>);</span><br><span class="line">                fmt ++ ;</span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="comment">/* flush the string found so far */</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">/* are we hitting the end? */</span></span><br><span class="line">            <span class="keyword">if</span>((*fmt) == <span class="number">0</span> ) <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*init the variable */</span></span><br><span class="line">        longFlag = <span class="number">0</span>;</span><br><span class="line">        negFlag = <span class="number">0</span>;</span><br><span class="line">        width = <span class="number">0</span>;</span><br><span class="line">        ladjust = <span class="number">0</span>;</span><br><span class="line">        prec = <span class="number">0</span>;</span><br><span class="line">        padc = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* we found a &#x27;%&#x27; */</span></span><br><span class="line">        fmt ++ ;</span><br><span class="line">        <span class="comment">/* check for long */</span></span><br><span class="line">        <span class="comment">// if( *fmt == &#x27;l&#x27; ) &#123;</span></span><br><span class="line">        <span class="comment">//     longFlag = 1;</span></span><br><span class="line">        <span class="comment">//     fmt ++ ;</span></span><br><span class="line">        <span class="comment">// &#125; </span></span><br><span class="line">        <span class="comment">/* check for other prefixes */</span></span><br><span class="line">        <span class="comment">/*check for flag */</span></span><br><span class="line">        <span class="keyword">if</span>(*fmt == <span class="string">&#x27;-&#x27;</span>) ladjust = <span class="number">1</span>, fmt ++;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(*fmt == <span class="string">&#x27;0&#x27;</span>) padc = <span class="string">&#x27;0&#x27;</span> , fmt ++;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*check for width */</span></span><br><span class="line">        <span class="keyword">while</span>( IsDigit(*fmt) ) &#123;</span><br><span class="line">            width = width * <span class="number">10</span> + Ctod(*fmt) ;</span><br><span class="line">            fmt ++ ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*check for precision */</span></span><br><span class="line">        <span class="keyword">if</span>(*fmt == <span class="string">&#x27;.&#x27;</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            fmt ++ ;</span><br><span class="line">            <span class="keyword">while</span>(IsDigit(*fmt))</span><br><span class="line">            &#123;</span><br><span class="line">                prec = prec * <span class="number">10</span> + Ctod(*fmt);</span><br><span class="line">                fmt ++ ;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* check for long */</span></span><br><span class="line">        <span class="keyword">if</span>( *fmt == <span class="string">&#x27;l&#x27;</span> ) &#123;</span><br><span class="line">            longFlag = <span class="number">1</span>;</span><br><span class="line">            fmt ++ ;</span><br><span class="line">        &#125; </span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* check format flag */</span></span><br><span class="line">        negFlag = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">switch</span> (*fmt) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> (longFlag) &#123; </span><br><span class="line">                num = va_arg(ap, <span class="type">long</span> <span class="type">int</span>); </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">                num = va_arg(ap, <span class="type">int</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            length = PrintNum(buf, num, <span class="number">2</span>, <span class="number">0</span>, width, ladjust, padc, <span class="number">0</span>);</span><br><span class="line">            OUTPUT(arg, buf, length);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;D&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> (longFlag) &#123; </span><br><span class="line">                num = va_arg(ap, <span class="type">long</span> <span class="type">int</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">                num = va_arg(ap, <span class="type">int</span>); </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (num &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                num = - num;</span><br><span class="line">                negFlag = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            length = PrintNum(buf, num, <span class="number">10</span>, negFlag, width, ladjust, padc, <span class="number">0</span>);</span><br><span class="line">            OUTPUT(arg, buf, length);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;o&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;O&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> (longFlag) &#123; </span><br><span class="line">                num = va_arg(ap, <span class="type">long</span> <span class="type">int</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">                num = va_arg(ap, <span class="type">int</span>); </span><br><span class="line">            &#125;</span><br><span class="line">            length = PrintNum(buf, num, <span class="number">8</span>, <span class="number">0</span>, width, ladjust, padc, <span class="number">0</span>);</span><br><span class="line">            OUTPUT(arg, buf, length);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;u&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;U&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> (longFlag) &#123; </span><br><span class="line">                num = va_arg(ap, <span class="type">long</span> <span class="type">int</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">                num = va_arg(ap, <span class="type">int</span>); </span><br><span class="line">            &#125;</span><br><span class="line">            length = PrintNum(buf, num, <span class="number">10</span>, <span class="number">0</span>, width, ladjust, padc, <span class="number">0</span>);</span><br><span class="line">            OUTPUT(arg, buf, length);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;x&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> (longFlag) &#123; </span><br><span class="line">                num = va_arg(ap, <span class="type">long</span> <span class="type">int</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">                num = va_arg(ap, <span class="type">int</span>); </span><br><span class="line">            &#125;</span><br><span class="line">            length = PrintNum(buf, num, <span class="number">16</span>, <span class="number">0</span>, width, ladjust, padc, <span class="number">0</span>);</span><br><span class="line">            OUTPUT(arg, buf, length);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;X&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> (longFlag) &#123; </span><br><span class="line">                num = va_arg(ap, <span class="type">long</span> <span class="type">int</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">                num = va_arg(ap, <span class="type">int</span>); </span><br><span class="line">            &#125;</span><br><span class="line">            length = PrintNum(buf, num, <span class="number">16</span>, <span class="number">0</span>, width, ladjust, padc, <span class="number">1</span>);</span><br><span class="line">            OUTPUT(arg, buf, length);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;c&#x27;</span>:</span><br><span class="line">            c = (<span class="type">char</span>)va_arg(ap, <span class="type">int</span>);</span><br><span class="line">            length = PrintChar(buf, c, width, ladjust);</span><br><span class="line">            OUTPUT(arg, buf, length);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">            s = (<span class="type">char</span>*)va_arg(ap, <span class="type">char</span> *);</span><br><span class="line">            length = PrintString(buf, s, width, ladjust);</span><br><span class="line">            OUTPUT(arg, buf, length);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;\0&#x27;</span>:</span><br><span class="line">            fmt --;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">/* output this char as it is */</span></span><br><span class="line">            OUTPUT(arg, fmt, <span class="number">1</span>);</span><br><span class="line">        &#125;	<span class="comment">/* switch (*fmt) */</span></span><br><span class="line"></span><br><span class="line">        fmt ++;</span><br><span class="line">    &#125;		<span class="comment">/* for(;;) */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* special termination call */</span></span><br><span class="line">    OUTPUT(arg, <span class="string">&quot;\0&quot;</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* --------------- local help functions --------------------- */</span></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">PrintChar</span><span class="params">(<span class="type">char</span> * buf, <span class="type">char</span> c, <span class="type">int</span> length, <span class="type">int</span> ladjust)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (length &lt; <span class="number">1</span>) length = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (ladjust) &#123;</span><br><span class="line">	    *buf = c;</span><br><span class="line">	    <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; length; i ++) buf[i] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i &lt; length - <span class="number">1</span>; i ++) buf[i] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        buf[length - <span class="number">1</span>] = c;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> length;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">PrintString</span><span class="params">(<span class="type">char</span> * buf, <span class="type">char</span>* s, <span class="type">int</span> length, <span class="type">int</span> ladjust)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">int</span> len=<span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span>* s1 = s;</span><br><span class="line">    <span class="keyword">while</span> (*s1++) len++;</span><br><span class="line">    <span class="keyword">if</span> (length &lt; len) length = len;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ladjust) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt; len; i++) buf[i] = s[i];</span><br><span class="line">        <span class="keyword">for</span> (i=len; i&lt; length; i++) buf[i] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt; length-len; i++) buf[i] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=length-len; i &lt; length; i++) buf[i] = s[i-length+len];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> length;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">PrintNum</span><span class="params">(<span class="type">char</span> * buf, <span class="type">unsigned</span> <span class="type">long</span> u, <span class="type">int</span> base, <span class="type">int</span> negFlag, </span></span><br><span class="line"><span class="params">	 <span class="type">int</span> length, <span class="type">int</span> ladjust, <span class="type">char</span> padc, <span class="type">int</span> upcase)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* algorithm :</span></span><br><span class="line"><span class="comment">     *  1. prints the number from left to right in reverse form.</span></span><br><span class="line"><span class="comment">     *  2. fill the remaining spaces with padc if length is longer than</span></span><br><span class="line"><span class="comment">     *     the actual length</span></span><br><span class="line"><span class="comment">     *     TRICKY : if left adjusted, no &quot;0&quot; padding.</span></span><br><span class="line"><span class="comment">     *		    if negtive, insert  &quot;0&quot; padding between &quot;0&quot; and number.</span></span><br><span class="line"><span class="comment">     *  3. if (!ladjust) we reverse the whole string including paddings</span></span><br><span class="line"><span class="comment">     *  4. otherwise we only reverse the actual string representing the num.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> actualLength =<span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> *p = buf;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="type">int</span> tmp = u %base;</span><br><span class="line">        <span class="keyword">if</span> (tmp &lt;= <span class="number">9</span>) &#123;</span><br><span class="line">            *p++ = <span class="string">&#x27;0&#x27;</span> + tmp;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (upcase) &#123;</span><br><span class="line">            *p++ = <span class="string">&#x27;A&#x27;</span> + tmp - <span class="number">10</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            *p++ = <span class="string">&#x27;a&#x27;</span> + tmp - <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        u /= base;</span><br><span class="line">    &#125; <span class="keyword">while</span> (u != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (negFlag) &#123;</span><br><span class="line">	    *p++ = <span class="string">&#x27;-&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//最终整个字符串要翻转</span></span><br><span class="line">    <span class="comment">/* figure out actual length and adjust the maximum length */</span></span><br><span class="line">    actualLength = p - buf;</span><br><span class="line">    <span class="keyword">if</span> (length &lt; actualLength) length = actualLength;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* add padding */</span></span><br><span class="line">    <span class="keyword">if</span> (ladjust) &#123;</span><br><span class="line">	    padc = <span class="string">&#x27; &#x27;</span>;<span class="comment">//左对齐就不能填充0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (negFlag &amp;&amp; !ladjust &amp;&amp; (padc == <span class="string">&#x27;0&#x27;</span>)) &#123;</span><br><span class="line">        <span class="comment">/*右对齐，同时要填充前导0，那就填充0(把字符&#x27;-&#x27;覆盖) */</span></span><br><span class="line">        <span class="keyword">for</span> (i = actualLength<span class="number">-1</span>; i &lt; length<span class="number">-1</span>; i++) buf[i] = padc; </span><br><span class="line">        buf[length <span class="number">-1</span>] = <span class="string">&#x27;-&#x27;</span>;<span class="comment">//第一位填&#x27;-&#x27;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	    <span class="keyword">for</span> (i = actualLength; i &lt; length; i++) buf[i] = padc;</span><br><span class="line">    &#125;</span><br><span class="line">	    </span><br><span class="line"></span><br><span class="line">    <span class="comment">/* prepare to reverse the string */</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> begin = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> end;</span><br><span class="line">        <span class="keyword">if</span> (ladjust) &#123;</span><br><span class="line">            end = actualLength - <span class="number">1</span>;<span class="comment">//如果是左对齐，只需要翻转数字部分(包括负号)</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            end = length <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (end &gt; begin) &#123;</span><br><span class="line">            <span class="type">char</span> tmp = buf[begin];</span><br><span class="line">            buf[begin] = buf[end];</span><br><span class="line">            buf[end] = tmp;</span><br><span class="line">            begin ++;</span><br><span class="line">            end --;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* adjust the string pointer */</span></span><br><span class="line">    <span class="keyword">return</span> length;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>唔，第一次写博客，就随便写了，好多东西是比较随性的，看到哪里想到哪里的，如果有不正确和不准确不完善的地方，请各位大佬联系我。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/03/09/os-lab1/" data-id="clf6rkls50001hkudcftbekg4" data-title="os-lab1" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/03/13/hello-world/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Hello World
        
      </div>
    </a>
  
  
</nav>

  
</article>


</section>
        <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/03/13/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2023/03/09/os-lab1/">os-lab1</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li></ul>
    </div>
  </div>

  
</aside>
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2023 By Autoload<br>
      Driven - <a href="https://hexo.io/" target="_blank">Hexo</a>|Theme - <a href="https://github.com/autoload/hexo-theme-auto" target="_blank">Auto</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>


<script src="/js/script.js"></script>




  </div>
</body>
</html>